# Настройка интеграции с Яндекс Картами

## Обзор

Система МКОР Flow Planner теперь поддерживает интеграцию с Яндекс Картами API для расчета расстояний и времени в пути между ЛПУ (Линейными Производственными Участками).

## Возможности

- **Расчет расстояний**: Точное расстояние между двумя ЛПУ
- **Матрица расстояний**: Расчет расстояний между множеством ЛПУ
- **Время в пути**: Оценка времени в пути с учетом средней скорости грузового транспорта
- **Оптимизация маршрутов**: Поиск оптимальных маршрутов между точками

## Настройка API ключа

### 1. Получение API ключа

1. Перейдите на [Яндекс.Разработчик](https://developer.tech.yandex.ru/)
2. Создайте аккаунт или войдите в существующий
3. Создайте новое приложение
4. В настройках приложения получите API ключ для JavaScript API

### 2. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
# Database
DATABASE_URL="file:./dev.db"

# Yandex Maps API
YANDEX_MAPS_API_KEY="ваш_api_ключ_здесь"

# Server
PORT=3001
```

### 3. Проверка настройки

После настройки API ключа система автоматически:
- Проверит валидность ключа при запуске
- Включит функционал расчета расстояний
- Покажет предупреждение, если ключ не настроен

## Использование

### В интерфейсе

1. Перейдите на вкладку "Логистика" в разделе отчетов
2. Используйте калькулятор расстояний для:
   - Расчет расстояния между двумя ЛПУ
   - Создание матрицы расстояний для множества ЛПУ

### API эндпоинты

#### Расчет расстояния между двумя ЛПУ
```
GET /api/distances/calculate?fromLpuId={id}&toLpuId={id}
```

#### Матрица расстояний
```
POST /api/distances/matrix
Content-Type: application/json

{
  "lpuIds": ["id1", "id2", "id3"]
}
```

#### Оптимальный маршрут
```
GET /api/distances/optimal-route?lpuIds={id1}&lpuIds={id2}
```

#### Список ЛПУ с координатами
```
GET /api/lpus/with-coordinates
```

## Требования к данным

### Координаты ЛПУ

Для корректной работы системы все ЛПУ должны иметь координаты:

```sql
-- Пример обновления координат ЛПУ
UPDATE Lpu 
SET latitude = 55.7558, longitude = 37.6176 
WHERE name = 'Название ЛПУ';
```

### Формат координат

- **Широта (latitude)**: от -90 до 90 градусов
- **Долгота (longitude)**: от -180 до 180 градусов
- **Точность**: рекомендуется до 6 знаков после запятой

## Алгоритмы расчета

### Формула гаверсинуса

Для расчета расстояния используется формула гаверсинуса:

```
a = sin²(Δφ/2) + cos(φ₁) × cos(φ₂) × sin²(Δλ/2)
c = 2 × atan2(√a, √(1−a))
d = R × c
```

Где:
- φ₁, φ₂ - широты точек
- Δφ, Δλ - разности широт и долгот
- R - радиус Земли (6,371,000 м)

### Оценка времени в пути

Время в пути рассчитывается с учетом:
- Средней скорости грузового транспорта: 60 км/ч
- Остановок и задержек: +20% к расчетному времени

## Ограничения

### API лимиты

- **Бесплатный план**: 25,000 запросов в день
- **Платный план**: до 1,000,000 запросов в день

### Точность расчетов

- **Расстояние**: ±1-2% от реального расстояния
- **Время в пути**: приблизительная оценка
- **Маршруты**: не учитывают дорожные условия в реальном времени

## Устранение неполадок

### Ошибка "API ключ не настроен"

1. Проверьте наличие файла `.env`
2. Убедитесь, что `YANDEX_MAPS_API_KEY` установлен
3. Перезапустите сервер

### Ошибка "Координаты ЛПУ не указаны"

1. Проверьте наличие координат в базе данных
2. Обновите координаты для ЛПУ без координат
3. Используйте геокодирование для получения координат по адресу

### Ошибка "Некорректные координаты"

1. Проверьте диапазон координат
2. Убедитесь в правильном формате (числа, а не строки)
3. Проверьте знаки координат (положительные/отрицательные)

## Дальнейшее развитие

### Планируемые улучшения

1. **Интеграция с Routing API**: Точные маршруты с учетом дорог
2. **Реальное время**: Учет дорожных условий и пробок
3. **Оптимизация маршрутов**: Алгоритмы для множественных точек
4. **Визуализация на карте**: Отображение маршрутов на интерактивной карте
5. **Кэширование**: Сохранение результатов расчетов для повторного использования

### Альтернативные сервисы

При необходимости можно интегрировать:
- **Google Maps API**: Глобальное покрытие
- **OpenStreetMap**: Бесплатное решение
- **2GIS API**: Российский сервис с хорошим покрытием

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Убедитесь в корректности API ключа
3. Проверьте наличие координат у ЛПУ
4. Обратитесь к документации Яндекс.Карт API 